<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PHOTON BLASTER — Light Emission Engine</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    background:#04000e;
    display:flex; flex-direction:column;
    align-items:center; justify-content:center;
    min-height:100vh;
    font-family:'Press Start 2P', monospace;
    overflow:hidden;
  }
  body::before {
    content:''; position:fixed; inset:0;
    background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,0,0,0.12) 3px,rgba(0,0,0,0.12) 4px);
    pointer-events:none; z-index:300;
  }
  body::after {
    content:''; position:fixed; inset:0;
    background:radial-gradient(ellipse at center, transparent 52%, rgba(0,0,0,0.78) 100%);
    pointer-events:none; z-index:301;
  }
  .title {
    font-size:clamp(8px,2vw,15px); color:#ffffff;
    text-shadow:0 0 8px #fff, 0 0 20px #aaf, 0 0 50px rgba(180,180,255,0.35);
    letter-spacing:2px; margin-bottom:4px; z-index:10;
    animation:flicker 7s infinite;
  }
  @keyframes flicker{0%,91%,100%{opacity:1}92%{opacity:.25}94%{opacity:1}96%{opacity:.45}98%{opacity:1}}
  .subtitle {
    font-size:clamp(5px,1vw,7px); color:#aaaaff;
    text-shadow:0 0 8px #aaaaff;
    margin-bottom:12px; letter-spacing:3px; z-index:10;
  }
  .screen-wrap {
    position:relative; z-index:10;
    border:3px solid #8844ff;
    box-shadow:0 0 0 3px #000,0 0 0 5px #ffffff,
      0 0 50px rgba(140,80,255,0.45),0 0 100px rgba(100,50,255,0.18);
    background:#04000e;
  }
  .corner{position:absolute;width:18px;height:18px;z-index:12;}
  .corner.tl{top:-4px;left:-4px;border-top:4px solid #fff;border-left:4px solid #fff;}
  .corner.tr{top:-4px;right:-4px;border-top:4px solid #fff;border-right:4px solid #fff;}
  .corner.bl{bottom:-4px;left:-4px;border-bottom:4px solid #fff;border-left:4px solid #fff;}
  .corner.br{bottom:-4px;right:-4px;border-bottom:4px solid #fff;border-right:4px solid #fff;}
  canvas{display:block;}
  .hud-row {
    display:flex; justify-content:space-between; align-items:flex-start;
    width:100%; max-width:980px; margin-top:10px; z-index:10; padding:0 4px; gap:12px;
  }
  .hud-group{display:flex;gap:18px;align-items:flex-start;flex-wrap:wrap;}
  .hud-box{display:flex;flex-direction:column;gap:3px;}
  .hud-label{font-size:5px;color:#8844ff;text-shadow:0 0 5px #8844ff;}
  .hud-value{font-size:9px;color:#fff;text-shadow:0 0 7px #fff;}
  .hud-small{font-size:6px;color:#aaaaff;text-shadow:0 0 5px #aaaaff;}
  .mode-selector{display:flex;flex-direction:column;gap:6px;z-index:10;}
  .mode-selector-label{font-size:5px;color:#8844ff;text-shadow:0 0 5px #8844ff;letter-spacing:1px;}
  .mode-btns{display:flex;gap:8px;}
  .mode-btn{
    font-family:'Press Start 2P',monospace; font-size:6px;
    padding:5px 9px;
    border:2px solid rgba(150,120,255,0.4);
    background:rgba(0,0,20,0.7);
    color:rgba(160,140,255,0.6);
    cursor:pointer; transition:all 0.15s; letter-spacing:1px;
  }
  .mode-btn:hover{border-color:rgba(200,170,255,0.7);color:rgba(220,200,255,0.9);}
  .mode-btn.active{
    border-color:#ffffff; color:#ffffff;
    text-shadow:0 0 8px #fff;
    box-shadow:0 0 12px rgba(200,180,255,0.4);
    background:rgba(60,40,120,0.8);
  }
  .uv-subbtn-row{display:flex;gap:6px;margin-top:2px;}
  .uv-subbtn{
    font-family:'Press Start 2P',monospace; font-size:5px; padding:4px 7px;
    border:1px solid rgba(150,100,255,0.35);
    background:rgba(0,0,20,0.6);
    color:rgba(150,100,255,0.55);
    cursor:pointer; transition:all 0.15s;
  }
  .uv-subbtn.active{border-color:#cc88ff;color:#cc88ff;text-shadow:0 0 6px #cc88ff;}
  #uvSubRow{display:none;}
  .insert-coin{
    font-size:7px;color:#ffffff;
    text-shadow:0 0 10px #8888ff;
    margin-top:8px;z-index:10;
    animation:blink 1.1s step-end infinite;letter-spacing:3px;
  }
  @keyframes blink{50%{opacity:0}}
</style>
</head>
<body>
<div class="title">✦ PHOTON  BLASTER ✦</div>
<div class="subtitle">ELECTRON TRANSITION → PHOTON EMISSION ENGINE</div>
<div class="screen-wrap">
  <div class="corner tl"></div><div class="corner tr"></div>
  <div class="corner bl"></div><div class="corner br"></div>
  <canvas id="c"></canvas>
</div>
<div class="hud-row">
  <div class="hud-group">
    <div class="hud-box">
      <div class="hud-label">SCORE</div>
      <div class="hud-value" id="scoreEl">00000000</div>
    </div>
    <div class="hud-box">
      <div class="hud-label">TRANSITION</div>
      <div class="hud-value" id="transEl" style="color:#fff">—</div>
    </div>
    <div class="hud-box">
      <div class="hud-label">WAVELENGTH</div>
      <div class="hud-small" id="waveEl">— nm</div>
    </div>
    <div class="hud-box">
      <div class="hud-label">PHOTON COLOR</div>
      <div class="hud-value" id="colorEl" style="font-size:8px">—</div>
    </div>
    <div class="hud-box">
      <div class="hud-label">EMITTED</div>
      <div class="hud-value" id="photonEl">00000</div>
    </div>
  </div>
  <div class="mode-selector">
    <div class="mode-selector-label">▶ EMISSION MODE</div>
    <div class="mode-btns">
      <button class="mode-btn active" id="btnVisible" onclick="setMode('visible')">VISIBLE</button>
      <button class="mode-btn" id="btnUV" onclick="setMode('uv')">ULTRAVIOLET</button>
    </div>
    <div class="uv-subbtn-row" id="uvSubRow">
      <button class="uv-subbtn active" id="btnUVA" onclick="setUVBand('uva')">UV-A</button>
      <button class="uv-subbtn" id="btnUVB" onclick="setUVBand('uvb')">UV-B</button>
      <button class="uv-subbtn" id="btnUVC" onclick="setUVBand('uvc')">UV-C</button>
    </div>
    <div class="hud-small" id="modeDesc" style="max-width:190px;line-height:1.8;margin-top:2px;">VISIBLE LIGHT 380–780nm</div>
  </div>
</div>
<div class="insert-coin">▶ DROP DOWN → EMIT PHOTON ◀</div>

<script>
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
const W = Math.min(window.innerWidth - 40, 980);
const H = Math.min(window.innerHeight * 0.60, 520);
canvas.width = W; canvas.height = H;

const ACX = W * 0.5;
const ACY = H * 0.5;
const ORBITAL_R = [0, 34, 62, 92, 122, 150];

// ── Mode state ────────────────────────────────────────────
let currentMode = 'visible';
let currentUVBand = 'uva';

const MODE_DESCS = {
  visible:  'VISIBLE LIGHT\n380–780nm',
  uv_uva:   'UV-A  315–400nm\nNear UV · Tanning',
  uv_uvb:   'UV-B  280–315nm\nSunburn · DNA damage',
  uv_uvc:   'UV-C  100–280nm\nGermicidal · Extreme',
};

function setMode(m) {
  currentMode = m;
  document.getElementById('btnVisible').classList.toggle('active', m==='visible');
  document.getElementById('btnUV').classList.toggle('active', m==='uv');
  document.getElementById('uvSubRow').style.display = m==='uv' ? 'flex' : 'none';
  updateModeDesc();
  resetElectrons();
}
function setUVBand(b) {
  currentUVBand = b;
  ['uva','uvb','uvc'].forEach(x =>
    document.getElementById('btn'+x.toUpperCase()).classList.toggle('active', x===b)
  );
  updateModeDesc();
  resetElectrons();
}
function updateModeDesc() {
  const key = currentMode==='visible' ? 'visible' : `uv_${currentUVBand}`;
  document.getElementById('modeDesc').textContent = MODE_DESCS[key];
}

// ── Wavelength → RGB ─────────────────────────────────────
function wlToRGB(nm, a=1) {
  let r=0,g=0,b=0;
  if     (nm>=380&&nm<440){r=(440-nm)/(440-380);g=0;b=1;}
  else if(nm<490)          {r=0;g=(nm-440)/(490-440);b=1;}
  else if(nm<510)          {r=0;g=1;b=(510-nm)/(510-490);}
  else if(nm<580)          {r=(nm-510)/(580-510);g=1;b=0;}
  else if(nm<645)          {r=1;g=(645-nm)/(645-580);b=0;}
  else if(nm<=780)         {r=1;g=0;b=0;}
  const gm=0.82;
  r=r>0?Math.pow(r,gm):0; g=g>0?Math.pow(g,gm):0; b=b>0?Math.pow(b,gm):0;
  return `rgba(${Math.round(r*255)},${Math.round(g*255)},${Math.round(b*255)},${a})`;
}

const UV_INFO = {
  uva: { color:'rgba(210,130,255,1)', glow:'#dd99ff', label:'UV-A', hazard:'LOW-MED RISK',  hcolor:'#ffdd66' },
  uvb: { color:'rgba(145,50,255,1)',  glow:'#aa33ff', label:'UV-B', hazard:'HIGH RISK',      hcolor:'#ff8833' },
  uvc: { color:'rgba(85,0,210,1)',    glow:'#6600ee', label:'UV-C', hazard:'EXTREME RISK',   hcolor:'#ff3333' },
};

// ── Transition pools ─────────────────────────────────────
// Visible: 7 equal colors across rainbow (generic multi-level atom)
const VISIBLE_POOL = [
  { nm:700, name:'RED',        from:3, to:2 },
  { nm:635, name:'ORANGE',     from:4, to:2 },
  { nm:590, name:'YELLOW',     from:5, to:2 },
  { nm:545, name:'GREEN',      from:6, to:2 },
  { nm:490, name:'CYAN',       from:7, to:2 },
  { nm:455, name:'BLUE',       from:8, to:2 },
  { nm:415, name:'VIOLET',     from:9, to:2 },
];

const UV_POOL = {
  uva: [
    { nm:390, name:'UV-A 390nm', from:5, to:1 },
    { nm:355, name:'UV-A 355nm', from:4, to:1 },
    { nm:320, name:'UV-A 320nm', from:3, to:1 },
  ],
  uvb: [
    { nm:310, name:'UV-B 310nm', from:8, to:1 },
    { nm:295, name:'UV-B 295nm', from:7, to:1 },
    { nm:282, name:'UV-B 282nm', from:6, to:1 },
  ],
  uvc: [
    { nm:260, name:'UV-C 260nm', from:5, to:1 },
    { nm:200, name:'UV-C 200nm', from:4, to:1 },
    { nm:130, name:'UV-C 130nm', from:3, to:1 },
  ],
};

function pickTransition() {
  if (currentMode==='visible') {
    return VISIBLE_POOL[Math.floor(Math.random() * VISIBLE_POOL.length)];
  }
  const pool = UV_POOL[currentUVBand];
  return pool[Math.floor(Math.random() * pool.length)];
}

function photonColor(tr) {
  return currentMode==='visible' ? wlToRGB(tr.nm, 1) : UV_INFO[currentUVBand].color;
}
function photonGlow(tr) {
  return currentMode==='visible' ? wlToRGB(tr.nm, 1) : UV_INFO[currentUVBand].glow;
}

// ── Electrons ─────────────────────────────────────────────
// State machine: ground → absorbing → excited → emitting → returning → ground
// Each electron always resets to n=1 after emission so orbits never get stuck at top
let electrons = [];
function makeElectron(id, startAngle, waitOffset) {
  return {
    id,
    n: 1,            // current RESTING level
    angle: startAngle,
    angSpeed: 0.020,
    state: 'ground',
    timer: 0,
    groundWait: 0.8 + waitOffset,
    // set during transitions:
    exciteTo: 1,     // target excited level
    dropTo: 1,       // target drop level after emission
    pendingTrans: null,
    // for smooth visual interpolation:
    interpFrom: 1,
    interpTo: 1,
    interpDur: 0.6,
    displayN: 1,
    // position
    screenX: ACX + 34, screenY: ACY,
    trail: [],
  };
}
function resetElectrons() {
  electrons = [
    makeElectron(0, 0,              0.0),
    makeElectron(1, Math.PI,        0.6),
    makeElectron(2, Math.PI * 0.5,  1.1),
    makeElectron(3, Math.PI * 1.5,  1.7),
  ];
}
resetElectrons();

// ── Particles ─────────────────────────────────────────────
const photons    = [];
const banners    = [];
const explosions = [];
let photonCount  = 0;
let score        = 0;

// ── Stars ─────────────────────────────────────────────────
const stars = Array.from({length:90}, () => ({
  x: Math.random()*W, y: Math.random()*H,
  r: Math.random()*1.4+0.2,
  phase: Math.random()*Math.PI*2,
  speed: 0.25 + Math.random()*1.2,
}));

let GT = 0; // global time
function lerp(a,b,t){ return a + (b-a)*t; }
function easeInOut(t){ return t<0.5 ? 2*t*t : -1+(4-2*t)*t; }

// ── Background ────────────────────────────────────────────
function drawBg() {
  stars.forEach(s => {
    const a = 0.07 + 0.22*Math.abs(Math.sin(GT*s.speed + s.phase));
    ctx.fillStyle = `rgba(200,180,255,${a})`;
    ctx.fillRect(s.x, s.y, s.r, s.r);
  });
}

// ── Orbits — FULLY STATIC ────────────────────────────────
function drawOrbits() {
  ctx.save();
  ctx.setLineDash([5, 9]);
  ctx.strokeStyle = 'rgba(75, 55, 138, 0.55)';
  ctx.lineWidth = 1;
  for (let n=1; n<=5; n++) {
    const r = ORBITAL_R[n];
    ctx.beginPath();
    ctx.arc(ACX, ACY, r, 0, Math.PI*2);
    ctx.stroke();
    // n= label (top)
    ctx.fillStyle = 'rgba(110, 90, 190, 0.65)';
    ctx.font = '5px "Press Start 2P"';
    ctx.textAlign = 'center';
    ctx.fillText(`n=${n}`, ACX, ACY - r - 5);
    // eV label (right)
    ctx.fillStyle = 'rgba(95, 75, 165, 0.50)';
    ctx.font = '4px "Press Start 2P"';
    ctx.textAlign = 'left';
    ctx.fillText(`${(-13.6/(n*n)).toFixed(1)}eV`, ACX + r + 4, ACY + 4);
  }
  ctx.restore();
}

// ── Nucleus ───────────────────────────────────────────────
function drawNucleus() {
  const p = 1 + 0.06*Math.sin(GT * 2.0);
  // Corona
  for (let i=4; i>0; i--) {
    ctx.beginPath();
    ctx.arc(ACX, ACY, 20*p + i*9, 0, Math.PI*2);
    ctx.strokeStyle = `rgba(255,${90+i*22},0,${0.05*i})`;
    ctx.lineWidth = 4;
    ctx.stroke();
  }
  // Core
  const cg = ctx.createRadialGradient(ACX-5,ACY-5,1, ACX,ACY,20*p);
  cg.addColorStop(0,   '#ffffff');
  cg.addColorStop(0.25,'#ffffaa');
  cg.addColorStop(0.55,'#ffaa00');
  cg.addColorStop(0.85,'#ff5500');
  cg.addColorStop(1,   'rgba(200,50,0,0.08)');
  ctx.shadowColor='#ff9900'; ctx.shadowBlur=28;
  ctx.fillStyle = cg;
  ctx.beginPath(); ctx.arc(ACX, ACY, 20*p, 0, Math.PI*2); ctx.fill();
  ctx.shadowBlur = 0;
  // Proton dots
  [[-5,-5],[5,-3],[-3,5],[5,5],[0,-8],[-7,2],[6,-7]].forEach(([dx,dy]) => {
    ctx.fillStyle = 'rgba(255,255,180,0.60)';
    ctx.fillRect(ACX+dx-1.5, ACY+dy-1.5, 3, 3);
  });
  // Label
  ctx.fillStyle = 'rgba(255,220,100,0.85)';
  ctx.font = 'bold 7px "Press Start 2P"';
  ctx.textAlign = 'center';
  ctx.fillText('H', ACX, ACY+38);
}

// ── Electron ──────────────────────────────────────────────
function updateDisplayN(e) {
  if (e.state==='absorbing' || e.state==='returning') {
    const f = easeInOut(Math.min(e.timer / e.interpDur, 1));
    e.displayN = lerp(e.interpFrom, e.interpTo, f);
  } else if (e.state==='excited' || e.state==='emitting') {
    e.displayN = e.exciteTo;
  } else {
    e.displayN = e.n;
  }
}

function drawElectron(e) {
  updateDisplayN(e);
  const dn  = Math.max(1, Math.min(e.displayN, 5.4));
  const r   = lerp(ORBITAL_R[1], ORBITAL_R[5], (dn-1)/4.4);
  const ex  = ACX + Math.cos(e.angle)*r;
  const ey  = ACY + Math.sin(e.angle)*r;
  e.screenX = ex; e.screenY = ey;

  const isExcited  = (e.state==='excited' || e.state==='emitting');
  const isMoving   = (e.state==='absorbing' || e.state==='returning');
  const eColor     = isExcited ? '#ffff44' : isMoving ? '#ccccff' : '#44aaff';
  const eGlow      = isExcited ? '#ffff00' : isMoving ? '#9999ff' : '#0077cc';

  // Excited aura
  if (isExcited) {
    const ha = ctx.createRadialGradient(ex,ey,3, ex,ey,28);
    ha.addColorStop(0, `rgba(255,255,55,${0.26+0.12*Math.sin(GT*9)})`);
    ha.addColorStop(1, 'transparent');
    ctx.fillStyle = ha;
    ctx.beginPath(); ctx.arc(ex,ey,28,0,Math.PI*2); ctx.fill();
  }

  // Trail
  e.trail.unshift({x:ex, y:ey});
  if (e.trail.length > 12) e.trail.pop();
  e.trail.forEach((p,i) => {
    ctx.globalAlpha = (1 - i/e.trail.length) * 0.20;
    ctx.fillStyle   = eColor;
    ctx.beginPath();
    ctx.arc(p.x, p.y, 3*(1-i/e.trail.length), 0, Math.PI*2);
    ctx.fill();
  });
  ctx.globalAlpha = 1;

  // Outer ring
  ctx.beginPath();
  ctx.arc(ex, ey, 9 + Math.sin(GT*3.5 + e.id)*1.2, 0, Math.PI*2);
  ctx.strokeStyle = eGlow;
  ctx.lineWidth   = 1.8;
  ctx.shadowColor = eGlow; ctx.shadowBlur = 16;
  ctx.stroke(); ctx.shadowBlur = 0;

  // Core
  const cg = ctx.createRadialGradient(ex-2,ey-2,0, ex,ey,8);
  cg.addColorStop(0, '#ffffff');
  cg.addColorStop(0.5, eColor);
  cg.addColorStop(1, 'transparent');
  ctx.shadowColor = eGlow; ctx.shadowBlur = 18;
  ctx.fillStyle   = cg;
  ctx.beginPath(); ctx.arc(ex,ey,8,0,Math.PI*2); ctx.fill();
  ctx.shadowBlur  = 0;

  // Minus symbol
  ctx.fillStyle    = '#fff';
  ctx.font         = 'bold 11px monospace';
  ctx.textAlign    = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText('−', ex, ey+1);
  ctx.textBaseline = 'alphabetic';

  // Excited label
  if (e.state === 'excited') {
    ctx.fillStyle   = '#ffff44';
    ctx.font        = '5px "Press Start 2P"';
    ctx.textAlign   = 'center';
    ctx.shadowColor = '#ffff00'; ctx.shadowBlur = 8;
    ctx.fillText('EXCITED!', ex, ey-20);
    ctx.shadowBlur  = 0;
  }
}

// ── Explosion rings ───────────────────────────────────────
function addExplosion(x, y, color, glow) {
  explosions.push({ x, y, color, glow, life:1,
    rings:[{r:10,spd:3.2},{r:6,spd:5.0},{r:16,spd:2.0}]
  });
}
function drawExplosions() {
  for (let i=explosions.length-1; i>=0; i--) {
    const e = explosions[i];
    e.life -= 0.020;
    if (e.life <= 0) { explosions.splice(i,1); continue; }
    e.rings.forEach(ring => {
      ring.r += ring.spd;
      ctx.beginPath(); ctx.arc(e.x, e.y, ring.r, 0, Math.PI*2);
      ctx.strokeStyle = e.color; ctx.lineWidth = 2.5;
      ctx.globalAlpha = e.life * 0.7;
      ctx.shadowColor = e.glow; ctx.shadowBlur = 18;
      ctx.stroke(); ctx.shadowBlur = 0;
    });
    // Center flash
    const fg = ctx.createRadialGradient(e.x,e.y,0, e.x,e.y,44*e.life);
    fg.addColorStop(0, `rgba(255,255,255,${e.life*0.8})`);
    fg.addColorStop(0.4, e.color.replace(/,1\)$/,`,${(e.life*0.6).toFixed(2)})`));
    fg.addColorStop(1, 'transparent');
    ctx.fillStyle = fg; ctx.globalAlpha = 1;
    ctx.beginPath(); ctx.arc(e.x,e.y,44*e.life,0,Math.PI*2); ctx.fill();
    ctx.globalAlpha = 1;
  }
}

// ── Color banners ─────────────────────────────────────────
function addBanner(x, y, name, color, nm) {
  banners.push({ x, y, name, color, nm, life:1, vy:-0.65 });
}
function drawBanners() {
  for (let i=banners.length-1; i>=0; i--) {
    const b = banners[i];
    b.y    += b.vy;
    b.life -= 0.011;
    if (b.life <= 0) { banners.splice(i,1); continue; }
    const a = Math.min(1, b.life * 2);
    ctx.globalAlpha = a;
    ctx.font = '10px "Press Start 2P"';
    const tw = ctx.measureText(b.name).width;
    const bx=b.x-tw/2-12, by=b.y-16, bw=tw+24, bh=22;
    ctx.fillStyle = 'rgba(0,0,0,0.78)';
    ctx.fillRect(bx, by, bw, bh);
    ctx.strokeStyle = b.color; ctx.lineWidth = 2.5;
    ctx.shadowColor = b.color; ctx.shadowBlur = 16;
    ctx.strokeRect(bx, by, bw, bh);
    ctx.fillStyle   = b.color; ctx.textAlign = 'center';
    ctx.fillText(b.name, b.x, b.y); ctx.shadowBlur = 0;
    ctx.font = '5px "Press Start 2P"';
    ctx.fillStyle = 'rgba(255,255,255,0.85)';
    ctx.fillText(`${b.nm} nm`, b.x, b.y+14);
    ctx.globalAlpha = 1;
  }
}

// ── Photon ────────────────────────────────────────────────
function spawnPhoton(e, tr) {
  const color = photonColor(tr);
  const glow  = photonGlow(tr);
  const nm    = tr.nm;
  const ex    = e.screenX, ey = e.screenY;
  const dir   = Math.atan2(ey-ACY, ex-ACX) + (Math.random()-0.5)*0.45;
  const spd   = 2.6;

  // Wave: violet = tight fast, red = wide slow
  const t01   = (nm - 100) / (780 - 100);
  const wFreq = lerp(0.076, 0.022, t01);
  const wAmp  = lerp(5, 16, t01);

  photons.push({
    x:ex, y:ey, vx:Math.cos(dir)*spd, vy:Math.sin(dir)*spd,
    dir, dist:0, color, glow, nm, name:tr.name,
    wFreq, wAmp, life:1,
    isUV: currentMode==='uv', uvBand: currentUVBand,
    trail:[], maxTrail:85,
  });

  addExplosion(ex, ey, color, glow);
  addBanner(ex, ey-32, tr.name, color, nm);

  document.getElementById('transEl').textContent = `n=${tr.from}→${tr.to}`;
  document.getElementById('transEl').style.color  = color;
  document.getElementById('waveEl').textContent   = `${nm} nm`;
  document.getElementById('waveEl').style.color   = color;
  document.getElementById('colorEl').textContent  = tr.name;
  document.getElementById('colorEl').style.color  = color;

  score       += 150 + (tr.from - tr.to) * 60;
  photonCount ++;
}

function drawPhoton(p) {
  const px = -Math.sin(p.dir);
  const py =  Math.cos(p.dir);

  if (p.trail.length > 3) {
    // Main colored trail
    ctx.beginPath();
    let first = true;
    for (let i=0; i<p.trail.length; i++) {
      const tp = p.trail[i];
      const ef = Math.sin(tp.dist * p.wFreq * Math.PI*2) * p.wAmp;
      const wx = tp.x + px*ef, wy = tp.y + py*ef;
      first ? (ctx.moveTo(wx,wy), first=false) : ctx.lineTo(wx,wy);
    }
    const hd = p.trail[0], tl = p.trail[p.trail.length-1];
    const g  = ctx.createLinearGradient(hd.x,hd.y, tl.x,tl.y);
    g.addColorStop(0,   p.color);
    g.addColorStop(0.3, p.color.replace(/,1\)$/,',0.55)'));
    g.addColorStop(0.7, p.color.replace(/,1\)$/,',0.14)'));
    g.addColorStop(1,   p.color.replace(/,1\)$/,',0)'));
    ctx.strokeStyle = g; ctx.lineWidth = 3.5;
    ctx.shadowColor = p.glow; ctx.shadowBlur = 13;
    ctx.globalAlpha = p.life;
    ctx.stroke();

    // UV extra wide glow
    if (p.isUV) {
      ctx.beginPath(); first=true;
      for (let i=0; i<p.trail.length; i++) {
        const tp = p.trail[i];
        const ef = Math.sin(tp.dist * p.wFreq * Math.PI*2) * p.wAmp;
        const wx = tp.x + px*ef, wy = tp.y + py*ef;
        first ? (ctx.moveTo(wx,wy), first=false) : ctx.lineTo(wx,wy);
      }
      ctx.strokeStyle = p.glow; ctx.lineWidth = 9;
      ctx.shadowColor = p.glow; ctx.shadowBlur = 22;
      ctx.globalAlpha = p.life * 0.16;
      ctx.stroke();
    }

    // White core highlight on leading section
    const fl = Math.min(32, p.trail.length);
    ctx.beginPath(); first=true;
    for (let i=0; i<fl; i++) {
      const tp = p.trail[i];
      const ef = Math.sin(tp.dist * p.wFreq * Math.PI*2) * p.wAmp;
      const wx = tp.x + px*ef, wy = tp.y + py*ef;
      first ? (ctx.moveTo(wx,wy), first=false) : ctx.lineTo(wx,wy);
    }
    const last = p.trail[fl-1] || p.trail[0];
    const wg = ctx.createLinearGradient(hd.x,hd.y, last.x,last.y);
    wg.addColorStop(0, 'rgba(255,255,255,0.95)');
    wg.addColorStop(1, 'rgba(255,255,255,0)');
    ctx.strokeStyle = wg; ctx.lineWidth = 1.2;
    ctx.shadowBlur  = 0;
    ctx.globalAlpha = p.life * 0.85;
    ctx.stroke();
  }

  // Head glow
  const hg = ctx.createRadialGradient(p.x,p.y,0, p.x,p.y,13);
  hg.addColorStop(0, 'rgba(255,255,255,1)');
  hg.addColorStop(0.35, p.color);
  hg.addColorStop(1, 'transparent');
  ctx.fillStyle   = hg;
  ctx.shadowColor = p.glow; ctx.shadowBlur = 28;
  ctx.globalAlpha = p.life;
  ctx.beginPath(); ctx.arc(p.x,p.y,11,0,Math.PI*2); ctx.fill();
  ctx.shadowBlur = 0; ctx.globalAlpha = 1;

  // Label
  if (p.life > 0.45) {
    const lbl = p.isUV ? `${UV_INFO[p.uvBand].label} ${p.nm}nm` : `${p.nm}nm`;
    ctx.fillStyle   = p.isUV ? UV_INFO[p.uvBand].glow : p.color;
    ctx.font        = '5px "Press Start 2P"';
    ctx.textAlign   = 'left';
    ctx.globalAlpha = p.life * 0.9;
    ctx.shadowColor = p.glow; ctx.shadowBlur = 6;
    ctx.fillText(lbl, p.x+14, p.y-6);
    ctx.shadowBlur = 0; ctx.globalAlpha = 1;
  }
}

// ── Spectrum / UV bar ─────────────────────────────────────
function drawSpectrumBar() {
  const bx=12, by=12, bw=W-24, bh=13;
  ctx.fillStyle = 'rgba(0,0,10,0.70)';
  ctx.fillRect(bx, by, bw, bh);

  if (currentMode === 'visible') {
    const sg = ctx.createLinearGradient(bx,0, bx+bw,0);
    sg.addColorStop(0,    '#7700cc');
    sg.addColorStop(0.12, '#4400ff');
    sg.addColorStop(0.22, '#0044ff');
    sg.addColorStop(0.38, '#00ccff');
    sg.addColorStop(0.52, '#00ff44');
    sg.addColorStop(0.66, '#ffff00');
    sg.addColorStop(0.82, '#ff7700');
    sg.addColorStop(1,    '#ff0000');
    ctx.fillStyle = sg; ctx.fillRect(bx, by, bw, bh);
    ctx.strokeStyle = 'rgba(255,255,255,0.18)'; ctx.lineWidth=1; ctx.strokeRect(bx,by,bw,bh);
    ctx.fillStyle = 'rgba(200,180,255,0.50)'; ctx.font='4px "Press Start 2P"';
    ctx.textAlign='left';  ctx.fillText('380nm', bx, by+bh+8);
    ctx.textAlign='right'; ctx.fillText('780nm', bx+bw, by+bh+8);
    ctx.textAlign='center'; ctx.fillStyle='rgba(255,255,255,0.30)';
    ctx.fillText('VISIBLE SPECTRUM  (380–780nm)', bx+bw/2, by+bh+8);
    // Active photon markers
    photons.forEach(ph => {
      if (ph.life<0.10 || ph.isUV) return;
      const frac = (ph.nm-380)/(780-380);
      const ppx  = bx + frac*bw;
      ctx.strokeStyle = '#fff'; ctx.lineWidth = 2;
      ctx.shadowColor = ph.color; ctx.shadowBlur = 10;
      ctx.globalAlpha = ph.life;
      ctx.beginPath(); ctx.moveTo(ppx,by-2); ctx.lineTo(ppx,by+bh+2); ctx.stroke();
      ctx.fillStyle = ph.color;
      ctx.beginPath(); ctx.moveTo(ppx,by-6); ctx.lineTo(ppx-4,by-1); ctx.lineTo(ppx+4,by-1); ctx.closePath(); ctx.fill();
      ctx.shadowBlur=0; ctx.globalAlpha=1;
    });
  } else {
    // UV zones
    const zones = [
      { label:'UV-C', band:'uvc', x0:0,    x1:0.30, color:'#5500cc' },
      { label:'UV-B', band:'uvb', x0:0.30, x1:0.45, color:'#9933ff' },
      { label:'UV-A', band:'uva', x0:0.45, x1:1.00, color:'#cc88ff' },
    ];
    zones.forEach(z => {
      const zx=bx+z.x0*bw, zw=(z.x1-z.x0)*bw;
      const active = z.band === currentUVBand;
      ctx.fillStyle   = z.color + (active ? 'cc' : '44');
      ctx.fillRect(zx, by, zw, bh);
      ctx.strokeStyle = z.color; ctx.lineWidth = active ? 2 : 1;
      ctx.strokeRect(zx, by, zw, bh);
      ctx.fillStyle   = active ? '#fff' : z.color;
      ctx.font='5px "Press Start 2P"'; ctx.textAlign='center';
      ctx.fillText(z.label, zx+zw/2, by+bh-2);
    });
    ctx.fillStyle='rgba(200,160,255,0.50)'; ctx.font='4px "Press Start 2P"';
    ctx.textAlign='left';  ctx.fillText('100nm', bx, by+bh+8);
    ctx.textAlign='right'; ctx.fillText('400nm', bx+bw, by+bh+8);
    ctx.textAlign='center'; ctx.fillStyle='rgba(200,160,255,0.35)';
    ctx.fillText('ULTRAVIOLET SPECTRUM  (100–400nm)', bx+bw/2, by+bh+8);
    // UV photon markers
    photons.forEach(ph => {
      if (ph.life<0.10 || !ph.isUV) return;
      const frac = (ph.nm-100)/(400-100);
      const ppx  = bx + frac*bw;
      const uvi  = UV_INFO[ph.uvBand];
      ctx.strokeStyle = uvi.glow; ctx.lineWidth = 2;
      ctx.shadowColor = uvi.glow; ctx.shadowBlur = 10;
      ctx.globalAlpha = ph.life;
      ctx.beginPath(); ctx.moveTo(ppx,by-2); ctx.lineTo(ppx,by+bh+2); ctx.stroke();
      ctx.fillStyle = uvi.color;
      ctx.beginPath(); ctx.moveTo(ppx,by-6); ctx.lineTo(ppx-4,by-1); ctx.lineTo(ppx+4,by-1); ctx.closePath(); ctx.fill();
      ctx.shadowBlur=0; ctx.globalAlpha=1;
    });
  }
}

// ── Energy level diagram ──────────────────────────────────
let diagFrom=3, diagTo=2, diagColor='#ff4444';
function drawEnergyDiagram() {
  const dx=12, dw=108;
  const dtop=H*0.12+30, dbot=H-12, dh=dbot-dtop;
  ctx.fillStyle   = 'rgba(0,0,14,0.82)';
  ctx.fillRect(dx, dtop, dw, dh);
  ctx.strokeStyle = 'rgba(100,80,192,0.40)'; ctx.lineWidth=1;
  ctx.strokeRect(dx, dtop, dw, dh);
  ctx.fillStyle   = 'rgba(140,120,255,0.70)';
  ctx.font='4px "Press Start 2P"'; ctx.textAlign='center';
  ctx.fillText('ENERGY', dx+dw/2, dtop+11);

  const Emin=-13.6, Emax=0;
  for (let n=1; n<=5; n++) {
    const En   = -13.6/(n*n);
    const ypos = dtop+18 + ((En-Emin)/(Emax-Emin))*(dh-26);
    const isA  = (n === Math.min(diagFrom,5));
    const isB  = (n === Math.min(diagTo,5));
    ctx.strokeStyle = (isA||isB) ? diagColor : 'rgba(90,70,162,0.50)';
    ctx.lineWidth   = (isA||isB) ? 2.5 : 1;
    ctx.shadowColor = (isA||isB) ? diagColor : 'transparent';
    ctx.shadowBlur  = (isA||isB) ? 10 : 0;
    ctx.beginPath(); ctx.moveTo(dx+6,ypos); ctx.lineTo(dx+dw-6,ypos); ctx.stroke();
    ctx.shadowBlur = 0;
    ctx.fillStyle  = (isA||isB) ? diagColor : 'rgba(155,135,255,0.60)';
    ctx.font='4px "Press Start 2P"'; ctx.textAlign='left';
    ctx.fillText(`n=${n}  ${En.toFixed(1)}eV`, dx+7, ypos-2);
  }
  // Transition arrow
  if (diagFrom && diagTo && diagFrom!==diagTo) {
    const clampedFrom = Math.min(diagFrom, 5);
    const clampedTo   = Math.min(diagTo, 5);
    const y1 = dtop+18 + ((-13.6/(clampedFrom*clampedFrom)-Emin)/(Emax-Emin))*(dh-26);
    const y2 = dtop+18 + ((-13.6/(clampedTo  *clampedTo  )-Emin)/(Emax-Emin))*(dh-26);
    const ax = dx + dw*0.68;
    ctx.strokeStyle = diagColor; ctx.lineWidth=2.2;
    ctx.shadowColor = diagColor; ctx.shadowBlur=12;
    ctx.beginPath(); ctx.moveTo(ax,y1); ctx.lineTo(ax,y2); ctx.stroke();
    ctx.fillStyle = diagColor;
    const td = (y2>y1) ? -1 : 1;
    ctx.beginPath();
    ctx.moveTo(ax, y2);
    ctx.lineTo(ax-5, y2+td*11);
    ctx.lineTo(ax+5, y2+td*11);
    ctx.closePath(); ctx.fill();
    ctx.shadowBlur = 0;
  }
}

// ── UV hazard badge ───────────────────────────────────────
function drawUVHazard() {
  if (currentMode !== 'uv') return;
  const uvi = UV_INFO[currentUVBand];
  const bx=W-165, by=H-56, bw=152, bh=44;
  ctx.fillStyle = 'rgba(10,0,22,0.85)'; ctx.fillRect(bx,by,bw,bh);
  ctx.strokeStyle = uvi.glow; ctx.lineWidth=2;
  ctx.shadowColor = uvi.glow; ctx.shadowBlur=10;
  ctx.strokeRect(bx,by,bw,bh); ctx.shadowBlur=0;
  ctx.fillStyle   = uvi.glow; ctx.font='6px "Press Start 2P"'; ctx.textAlign='center';
  ctx.shadowColor = uvi.glow; ctx.shadowBlur=8;
  ctx.fillText(uvi.label, bx+bw/2, by+14); ctx.shadowBlur=0;
  ctx.fillStyle   = uvi.hcolor; ctx.font='5px "Press Start 2P"';
  ctx.fillText(uvi.hazard, bx+bw/2, by+28);
  const nmRanges = { uva:'315–400nm', uvb:'280–315nm', uvc:'100–280nm' };
  ctx.fillStyle = 'rgba(200,170,255,0.60)'; ctx.font='4px "Press Start 2P"';
  ctx.fillText(nmRanges[currentUVBand], bx+bw/2, by+42);
}

// ── Main loop ─────────────────────────────────────────────
function frame() {
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle='#04000e'; ctx.fillRect(0,0,W,H);

  drawBg();
  drawOrbits();   // static — drawn every frame at fixed opacity

  // ── Update electron state machines ──────────────────────
  electrons.forEach(e => {
    // Orbital speed: faster near nucleus (Kepler-like), kept slow overall
    const dn = Math.max(1, Math.min(e.displayN||e.n, 5.4));
    const r  = lerp(ORBITAL_R[1], ORBITAL_R[5], (dn-1)/4.4);
    e.angle += e.angSpeed * (ORBITAL_R[1]/r) * 0.55;
    e.timer += 0.016;

    switch (e.state) {
      case 'ground':
        if (e.timer >= e.groundWait) {
          const tr     = pickTransition();
          e.pendingTrans = tr;
          e.exciteTo   = Math.min(tr.from, 5.4);
          e.interpFrom = e.n;
          e.interpTo   = e.exciteTo;
          e.interpDur  = 0.65;
          e.state      = 'absorbing';
          e.timer      = 0;
        }
        break;

      case 'absorbing':
        if (e.timer >= e.interpDur) {
          e.n     = Math.round(e.exciteTo);
          e.state = 'excited';
          e.timer = 0;
          e.excitedDuration = 0.7 + Math.random()*0.9;
        }
        break;

      case 'excited':
        if (e.timer >= e.excitedDuration) {
          e.state = 'emitting';
          e.timer = 0;
        }
        break;

      case 'emitting': {
        const tr = e.pendingTrans || pickTransition();
        spawnPhoton(e, tr);
        diagFrom   = tr.from;
        diagTo     = tr.to;
        diagColor  = photonColor(tr);
        // Return electron to n=1 (ground)
        e.interpFrom = e.exciteTo;
        e.interpTo   = 1;
        e.interpDur  = 0.70;
        e.dropTo     = 1;
        e.state      = 'returning';
        e.timer      = 0;
        break;
      }

      case 'returning':
        if (e.timer >= e.interpDur) {
          e.n            = 1;
          e.exciteTo     = 1;
          e.pendingTrans = null;
          e.state        = 'ground';
          e.timer        = 0;
          e.groundWait   = 0.6 + Math.random()*0.9;
        }
        break;
    }
  });

  // ── Draw scene ──────────────────────────────────────────
  drawExplosions();

  // Update & draw photons
  for (let i=photons.length-1; i>=0; i--) {
    const p = photons[i];
    p.trail.unshift({x:p.x, y:p.y, dist:p.dist});
    if (p.trail.length > p.maxTrail) p.trail.pop();
    p.x    += p.vx; p.y += p.vy;
    p.dist += Math.sqrt(p.vx*p.vx + p.vy*p.vy);
    p.life  = Math.max(0, 1 - p.dist/(Math.max(W,H)*1.12));
    if (p.life<=0 || p.x<-160||p.x>W+160||p.y<-160||p.y>H+160) {
      photons.splice(i,1); continue;
    }
    drawPhoton(p);
  }

  drawNucleus();
  electrons.forEach(e => drawElectron(e));
  drawBanners();
  drawSpectrumBar();
  drawEnergyDiagram();
  drawUVHazard();

  // Score
  ctx.fillStyle   = '#ffffff'; ctx.font='7px "Press Start 2P"';
  ctx.textAlign   = 'right';
  ctx.shadowColor = '#8888ff'; ctx.shadowBlur=8;
  ctx.fillText(`SCORE: ${String(score).padStart(8,'0')}`, W-12, H*0.12+28);
  ctx.shadowBlur = 0;

  // Physics note
  ctx.fillStyle = 'rgba(140,120,210,0.38)'; ctx.font='4px "Press Start 2P"';
  ctx.fillText('E=hf=hc/λ  |  DROP DOWN → EMIT PHOTON', W-12, H-8);

  // Model note
  ctx.textAlign   = 'left';
  ctx.fillStyle   = 'rgba(110,90,185,0.40)'; ctx.font='4px "Press Start 2P"';
  const note = currentMode==='visible'
    ? 'GENERIC MULTI-LEVEL ATOM (equal color distribution)'
    : 'HYDROGEN ATOM — LYMAN SERIES (transitions to n=1)';
  ctx.fillText(note, 120, H-8);

  // DOM HUD
  document.getElementById('scoreEl').textContent  = String(score).padStart(8,'0');
  document.getElementById('photonEl').textContent = String(photonCount).padStart(5,'0');

  GT += 0.016;
  requestAnimationFrame(frame);
}

frame();
</script>
</body>
</html>
